# Project Phases

This updated plan merges the original roadmap with the latest revisions to keep every task current and traceable.

## Phase 1 â€“ Setup & Data Ingestion âœ… **COMPLETED**

**Goal**: Establish the core infrastructure and create a highâ€‘quality, indexed knowledge base.

**Key deliverables** (all completed): FastAPI stack, LlamaIndex ingestion, PGVectorStore, Langfuse tracing, full test & lint gate.

## Phase 2 â€“ Query Engine Development & Evaluation âœ… **COMPLETED**

**Goal**: Ship a measured baseline RAG pipeline with an authenticated /chat endpoint and evaluation dataset.

**Key deliverables** (all completed): VectorStoreIndex query engine, OpenRouter LLM, goldenâ€‘dataset, Langfuse evals, CIâ€‘guarded quality metrics.

## Road Map (Phase 3 â†’ Phase 4)

| Phase | Goal | Key Deliverables |
|-------|------|------------------|
| 3A â€“ Robust Core | Harden monolith for low/medium traffic | âœ… sync API workers, inâ€‘mem cache, PGVector column + GIN index, Redis rateâ€‘limit, Langfuse try/catch, structured logs, custom error codes |
| 3B â€“ LLM & RAG Upgrades | Model fallbacks, embeddings, streaming | âœ… provider router (Gemini / Groq / ChatGPT + local), embedding switch, streaming responses, default "sorry" fallback |
| 3C â€“ DX & Docs | Code, schema, docs hygiene | âœ… deadâ€‘code drop, checksum UPSERTs, docâ€‘lint CI |
| 3D â€“ Prodâ€‘Ready Container | Secure slim image | âœ… multiâ€‘stage Dockerfile, nonâ€‘root user, HEALTHCHECK |
| 4A â€“ Testing Maturity | â‰¥80 % criticalâ€‘path coverage | âœ… unit, integration, E2E, fuzz, coverage gate |
| 4B â€“ Feature Growth | Memory, doc API, versioning | âœ… Redis convo memory, doc upload/version, metadata, Streamlit demo |
| 4C â€“ Optional | Feedback, WordPress, serverless PoC | Defer until needed |

## ðŸ”Ž Detailed Toâ€‘Do Backlog (Authoritative)

### 1 Â· Core Hardening (3A)

| Branch | Task | Tests |
|--------|------|-------|
| `feat/rate-limit-redis` | Fixedâ€‘window perâ€‘IP limit â†’ 429 w/ resetâ€‘after header | Unit window math; Integration exceed limit via pytestâ€‘httpx |
| `feat/cache-lru` | cachetools.TTLCache on get_chat_response keyed by question | Unit hit/miss timing |
| `chore/cors-env` | Centralise settings.ALLOW_ORIGINS; default * in DEBUG | Unit env override |
| `feat/structured-logs` | logging.config.dictConfig, 100 MB rotate | Unit file creation & rotation |
| `fix/pgvector-type` | Migrate content_vector TEXT â†’ VECTOR(1536) + USING ivfflat GIN | Integration â‰¤ 50 ms 1 kâ€‘vec similarity |

### 2 Â· LLM & RAG Upgrades (3B)

| Branch | Task | Tests |
|--------|------|-------|
| `feat/llm-router` | Priorityâ€‘based provider router w/ timeouts & automatic fallback | Unit forced timeout chains |
| `feat/embedding-switch` | Gemini / ChatGPT embeddings with fallback to HF | Integration cosine within Â±0.02 |
| `feat/streaming` | StreamingResponse when answer > 300 chars | E2E client chunk reception |
| `feat/fallback-msg` | Generic apology + traceâ€‘id on unhandled error | Unit MockLLMError |

### 3 Â· Schema & Docs Cleanâ€‘up (3C)

| Branch | Task | Tests |
|--------|------|-------|
| `chore/drop-unused-models` | Delete QueryLog, stub Vector | â€” |
| `feat/upsert-ingest` | SHAâ€‘256 per page, UPSERT new/changed chunks | Integration rows stable on 1â€‘page edit |
| `chore/docs-sync` | Align env vars, add docâ€‘lint to preâ€‘commit | CI docâ€‘lint job |

### 4 Â· Container Hardening (3D)

| Branch | Task | Tests |
|--------|------|-------|
| `infra/multistage-docker` | Builderâ†’runtime stages, strip dev deps, nonâ€‘root app, HEALTHCHECK | CI image < 400 MB |
| `infra/prometheus` | prometheus_fastapi_instrumentator, /metrics endpoint | Integration scrape returns http_requests_total |

### 5 Â· Testing Expansion (4A)

| Branch | Task | Scope |
|--------|------|-------|
| `test/unit-index` | PGVector inâ€‘mem mock (sqlite+vector) | Unit |
| `test/integration-rag` | Spin Postgres/Redis via pytestâ€‘docker | Integration |
| `test/e2e-stream` | Longâ€‘Q streaming test on /chat | E2E |
| `test/fuzz-heuristic` | Random promptâ€‘injection & malformed PDF | Heuristic |

**Target coverage gate**: 80 % lines, 90 % functions on app/.

### 6 Â· Memory & Doc Management (4B)

| Branch | Task | Tests |
|--------|------|-------|
| `feat/redis-memory` | Persist last N Q&A by session_id; prepend to prompt | Unit contextâ€‘length enforcement |
| `feat/doc-upload-api` | /api/v1/docs POST/PUT for upload + version | Integration ingest then query new content |
| `feat/metadata-schema` | documents table (id, path, version, uploaded_at, author, tags) | Integration CRUD |

## ðŸ“ Detailed Implementation Steps

### 1 Â· Core Hardening (3A) - Detailed Tasks

#### Rate Limiting Implementation (`feat/rate-limit-redis`)

- [ ] Implement per-IP fixed window Redis-based rate limiting
- [ ] Return 429 status with 24h reset message on limit exceeded
- [ ] Add unit tests for window calculation edge cases
- [ ] Add integration tests via pytest-httpx for rate limit scenarios

#### Caching & Performance (`feat/cache-lru`)

- [ ] Add `cachetools.TTLCache` decorator on `get_chat_response` (key=`question`)
- [ ] Implement cache hit/miss timing tests
- [ ] Configure appropriate TTL for chat responses

#### CORS Configuration (`chore/cors-env`)

- [ ] Move CORS origins to `settings.ALLOW_ORIGINS`
- [ ] Set default `*` in DEBUG mode
- [ ] Add unit tests for environment override

#### Structured Logging (`feat/structured-logs`)

- [ ] Implement `logging.config.dictConfig`
- [ ] Add log file pattern `logs/app_%(process)d_%Y%m%d.log` with rotation (100MB)
- [ ] Add unit tests for file creation and rotation

#### Database Optimization (`fix/pgvector-type`)

- [ ] Replace `content_vector TEXT` â†’ `VECTOR(1536)` via Alembic migration
- [ ] Add `USING ivfflat` GIN index for performance
- [ ] Add integration tests for similarity query latency < 50ms on 1k vectors

### 2 Â· LLM & RAG Upgrades (3B) - Detailed Tasks

#### LLM Router Implementation (`feat/llm-router`)

- [ ] Abstract `LLMProvider` with priorities and timeouts
- [ ] Implement automatic fallback mechanism
- [ ] Add unit tests for forced timeout triggering next model
- [ ] Support multiple providers (Gemini, Groq/Claude, ChatGPT + local)

#### Embedding Provider Switch (`feat/embedding-switch`)

- [ ] Implement embedding via Gemini/ChatGPT with provider flag
- [ ] Add fallback to HuggingFace model
- [ ] Add integration tests for identical cosine score Â±0.02

#### Streaming Responses (`feat/streaming`)

- [ ] Return `StreamingResponse` when answer > 300 characters
- [ ] Add E2E tests for client receiving chunks
- [ ] Implement proper error handling in streaming

#### Fallback Messaging (`feat/fallback-msg`)

- [ ] On unhandled exceptions, send 200 with predefined apology + trace ID
- [ ] Add unit tests with `MockLLMError`
- [ ] Implement graceful degradation patterns

### 3 Â· Schema & Docs Cleanâ€‘up (3C) - Detailed Tasks

#### Code Cleanup (`chore/drop-unused-models`)

- [ ] Remove `QueryLog` + stub `Vector` models
- [ ] Plan for real audit log implementation later
- [ ] Clean up dead code and unused imports

#### Incremental Ingestion (`feat/upsert-ingest`)

- [ ] Implement SHA-256 per page in ingestion script
- [ ] Add UPSERT logic for only new/changed chunks
- [ ] Add integration tests: update 1 page, DB rows count remains same

#### Documentation Sync (`chore/docs-sync`)

- [ ] Align environment variable names across docs
- [ ] Add doc-lint (markdown-link-check, doctoc) to pre-commit
- [ ] Add CI doc-lint job
- [ ] Update .env examples and README files

### 4 Â· Container Hardening (3D) - Detailed Tasks

#### Multi-stage Dockerfile (`infra/multistage-docker`)

- [ ] Implement builder â†’ runtime stage separation
- [ ] Exclude dev dependencies from runtime
- [ ] Add non-root `app` user
- [ ] Add HEALTHCHECK endpoint
- [ ] CI job: ensure image < 400MB

#### Monitoring Integration (`infra/prometheus`)

- [ ] Add `prometheus_fastapi_instrumentator`
- [ ] Expose `/metrics` endpoint
- [ ] Add integration tests for scraping `http_requests_total`

### 5 Â· Testing Expansion (4A) - Detailed Tasks

#### Unit Testing Expansion (`test/unit-index`)

- [ ] Implement PGVector in-memory mock (sqlite+vector)
- [ ] Add comprehensive unit test coverage
- [ ] Target: 80% line coverage, 90% function coverage on `app/`

#### Integration Testing (`test/integration-rag`)

- [ ] Set up Postgres/Redis via pytest-docker
- [ ] Implement end-to-end RAG pipeline tests
- [ ] Test ingestion â†’ query â†’ response flow

#### E2E Testing (`test/e2e-stream`)

- [ ] Test `/chat` endpoint with long questions
- [ ] Assert proper streaming behavior
- [ ] Validate full system integration

#### Security Testing (`test/fuzz-heuristic`)

- [ ] Implement random prompt injection string testing
- [ ] Ensure proper sanitization
- [ ] Test malformed PDF handling
- [ ] Add heuristic fuzz testing

#### Coverage Gates

- [ ] Implement `pytest --cov=app --cov-fail-under=80`
- [ ] Add coverage reporting to CI/CD
- [ ] Set up coverage gate in branch protection

### 6 Â· Memory & Doc Management (4B) - Detailed Tasks

#### Conversation Memory (`feat/redis-memory`)

- [ ] Store last N Q&A pairs per `session_id` in Redis
- [ ] Prepend conversation context to prompts
- [ ] Add unit tests for context length logic
- [ ] Implement memory cleanup strategies

#### Document Management API (`feat/doc-upload-api`)

- [ ] Implement `/api/v1/docs` POST for new file uploads
- [ ] Add PUT endpoint for document versioning
- [ ] Add integration tests: upload â†’ ingest â†’ query returns new content
- [ ] Implement file validation and security

#### Metadata Schema (`feat/metadata-schema`)

- [ ] Add `documents` table (id, path, version, uploaded_at, author, tags)
- [ ] Implement metadata CRUD operations
- [ ] Add integration tests for metadata management
- [ ] Support document tagging and categorization

#### Streamlit Demo (`feat/demo-ui`)

- [ ] Create user-friendly demo interface
- [ ] Implement file upload functionality
- [ ] Add conversation history display
- [ ] Rate limit message UX improvements

### 7 Â· Optional Features (4C) - Deferred Tasks

#### User Feedback System

- [ ] Implement feedback collection API
- [ ] Integrate with Langfuse for quality tracking
- [ ] Add feedback-based model improvements

#### WordPress Plugin

- [ ] Develop WordPress integration
- [ ] Create plugin for easy embedding
- [ ] Document installation and configuration

#### Serverless PoC

- [ ] Explore serverless deployment options
- [ ] Implement cost optimization strategies
- [ ] Create deployment automation

## Testing Methodologies

**Unit** â€“ stateless pure functions; LLMs mocked

**Integration** â€“ local Postgres / Redis via pytestâ€‘docker; run ingest â†’ query

**E2E** â€“ dockerâ€‘compose full stack; HTTP smoke tests

**Heuristic / Fuzz** â€“ adversarial prompts, malformed PDFs

**Coverage Gate** â€“ pytest --cov=app --cov-fail-under=80

## Branch Protection & CI Matrix

| Job | Trigger | Steps |
|-----|---------|-------|
| lint | PR | ruff, pyupgrade, mypy |
| unit-test | PR | pytest -m unit |
| integration-test | PR label integration or main | spin DB / Redis, run tests |
| docker-build | tag on main | build, Trivy scan, push ghcr.io |
| doc-lint | PR | markdownlintâ€‘cli2, linkâ€‘check |

## Git Branching & PR Workflow

```
main             # always deployable
â””â”€â”€ develop      # integration
    â”œâ”€â”€ feat/<slug>/â€¦
    â”œâ”€â”€ fix/<slug>/â€¦
    â”œâ”€â”€ chore/<infraâ€‘slug>/â€¦
    â””â”€â”€ test/<slug>/â€¦
```

**Rule per PR**: One topic, â‰¤ 400 LoC, checklist must pass.

## Release Tags

**v0.x.y** # dev/demo
**v1.x.y** # first prod cut

Tag triggers Docker build â†’ DigitalOcean Container Registry deploy.

## Development Commands (Phase 3)

```bash
make up           # start services
make down         # stop services
make logs         # view logs
make test         # all tests (â‰¥14 pass)
make lint         # code quality
make format       # format code
make shell        # container shell
make db-shell     # psql
make ingest       # reâ€‘ingest PDFs
# Baseline eval
docker exec chatbot-api-service-app-1 python scripts/run_baseline_evaluation.py
# Smoke test
curl -X POST "http://localhost:8000/api/v1/chat" \
     -H "Content-Type: application/json" \
     -H "X-API-Key: <key>" \
     -d '{"question":"test","session_id":"test"}'
```

## Quality Metrics (Achieved)

âœ… **14+ tests** âœ… **Chat coverage** âœ… **Lint & type clean** âœ… **Secrets scan & APIâ€‘key auth** âœ… **Docs & guides** âœ… **Langfuse tracing** (config fix pending)

## Immediate Priorities (Top 4)

1. **Langfuse Config Fix** â€“ solve CLICKHOUSE_URL, verify tracing, dataset creation.
2. **Redis Rateâ€‘Limit** â€“ branch feat/rate-limit-redis, hard 429, tests.
3. **PGVector Migration** â€“ branch fix/pgvector-type, vector â†’ VECTOR(1536), ivfflat index.
4. **Docker Hardening** â€“ branch infra/multistage-docker, image < 400 MB, add HEALTHCHECK + Trivy clean.

Complete in sequence; each merged PR closes its table entry.
