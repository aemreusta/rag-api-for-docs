# ClickHouse + Langfuse v3 Stack — Operator Runbook

> **Scope**  Self‑hosted Langfuse v3 with ClickHouse analytics for the **ai‑gateway** chatbot behind *hurriyetpartisi.org*.
> **Outcome**  One‑command deploy, deterministic migrations, robust debug playbook, CI guardrails.

---

## 0 · Quick checklist

| ✔️ | Step                   | Command / File                                                        |
| -- | ---------------------- | --------------------------------------------------------------------- |
|    | 1. Create secrets      | `cp .env.example .env && openssl rand -hex 32` (three times)          |
|    | 2. Reset CK on upgrade | `make clickhouse-reset`                                               |
|    | 3. Boot services       | `docker compose pull && docker compose up -d`                         |
|    | 4. Health probe        | `curl -f http://localhost:3000/api/public/health` ⇒ `{"status":"ok"}` |
|    | 5. UI sign‑in          | open `/auth/sign-up`, create first owner                              |

Check all ticks ➜ stack is ready.

---

## 1 · Prerequisites

* **Docker 24+** with Compose plugin.
* **Ports** free: 3000 (Langfuse UI), 8123/9000 (ClickHouse), 5432 (Postgres), 6379 (Redis).
* **64‑hex secret** for `CLICKHOUSE_PASSWORD`; **32‑hex** for `NEXTAUTH_SECRET`.

---

## 2 · Environment file (`.env`)

```dotenv
# ── ClickHouse ──
CLICKHOUSE_URL=http://clickhouse:8123
CLICKHOUSE_MIGRATION_URL=clickhouse://clickhouse:9000
CLICKHOUSE_USER=langfuse
CLICKHOUSE_PASSWORD=<64‑hex>
CLICKHOUSE_DB=langfuse
CLICKHOUSE_CLUSTER_ENABLED=false

# ── Langfuse ──
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=<32‑hex>
AUTH_DISABLE_SIGNUP=false   # toggle after first owner exists
```

> **Tip**  Add `SMTP_*` keys now if you need password‑reset e‑mails.

---

## 3 · Compose services (essentials)

```yaml
clickhouse:
  image: clickhouse/clickhouse-server:24.3
  environment:
    CLICKHOUSE_USER: langfuse
    CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
    CLICKHOUSE_DB: langfuse
    CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
  healthcheck:
    test: ["CMD-SHELL", "wget -qO- http://localhost:8123/ping || exit 1"]
    interval: 5s
    retries: 20

langfuse:
  image: ghcr.io/langfuse/langfuse:latest
  env_file: .env
  depends_on:
    clickhouse:
      condition: service_healthy

langfuse-worker:
  image: ghcr.io/langfuse/langfuse:latest
  env_file: .env
  environment:
    LANGFUSE_AUTO_CLICKHOUSE_MIGRATION_DISABLED: "true"
  depends_on:
    langfuse:
      condition: service_started
```

*`CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1`* stops the blank‑password bug. Worker waits, so only the web runs migrations.

---

## 4 · First‑time (or upgrade) procedure

1. **Stop old stack**  `docker compose down`
2. **Optional wipe**   `make clickhouse-reset` (drops `clickhouse_data` volume)
3. **Boot**            `docker compose pull && docker compose up -d`
4. **Tail CK logs**    `docker compose logs -f clickhouse | grep "Ready for connections"`
5. **Health probe**    `curl -f http://localhost:3000/api/public/health`
6. **Create owner**    open `/auth/sign-up` → enter `admin@hurriyetpartisi.org` + password.

---

## 5 · Smoke tests (copy‑paste)

```bash
# 1. ClickHouse auth round‑trip
CKPW=$(grep CLICKHOUSE_PASSWORD .env | cut -d= -f2)
docker compose exec clickhouse clickhouse-client -u langfuse --password $CKPW -q "SELECT 1"   # -> 1

# 2. Grants
docker compose exec clickhouse clickhouse-client -u langfuse --password $CKPW -q "SHOW GRANTS" | grep langfuse

# 3. Langfuse health
curl -f http://localhost:3000/api/public/health
```

---

## 6 · Deep‑debug playbook

| What to inspect           | Command                                                                                                     |                   |
| ------------------------- | ----------------------------------------------------------------------------------------------------------- | ----------------- |
| Env vars inside container | \`docker compose exec langfuse printenv                                                                     | grep CLICKHOUSE\` |
| Langfuse migration list   | `docker compose exec langfuse sqlite3 /data/sqlite.db '.tables'` *(self‑host DB for ORM state)*             |                   |
| ClickHouse system tables  | `docker compose exec clickhouse clickhouse-client -q 'SELECT * FROM system.users WHERE name="langfuse"'`    |                   |
| Pending mutations         | `docker compose exec clickhouse clickhouse-client -q 'SELECT database,table,is_done FROM system.mutations'` |                   |
| Firewall / port           | `docker exec -it $(docker ps -q -f name=langfuse) bash -c 'nc -zv clickhouse 9000'`                         |                   |

### Common errors & fixes

| Log snippet                                       | Root cause         | Fix                                                                                         |
| ------------------------------------------------- | ------------------ | ------------------------------------------------------------------------------------------- |
| `Code: 516, DB::Exception: Authentication failed` | password mismatch  | re‑export correct `CLICKHOUSE_PASSWORD` in both compose & .env, then `docker compose up -d` |
| `driver: bad connection`                          | URL uses localhost | replace with service name `clickhouse`                                                      |
| `schema_migrations already locked`                | web & worker raced | ensure worker flag `LANGFUSE_AUTO_CLICKHOUSE_MIGRATION_DISABLED=true`                       |
| `Sign‑up disabled` banner                         | auth locked        | set `AUTH_DISABLE_SIGNUP=false` until owner is created then flip back                       |

---

## 7 · CI / CD guardrail

```yaml
jobs:
  e2e-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Launch stack
        run: docker compose up -d --wait
      - name: Probe health
        run: curl -f http://localhost:3000/api/public/health
```

Fails fast when env vars go missing.

---

## 8 · Initial User, Organisation & Project Bootstrap

> **Goal**  Create the first owner account, organisation and project so Langfuse becomes usable and API keys exist.

### 8.1 Fast interactive sign‑up (🌐 UI)

1. Confirm `AUTH_DISABLE_SIGNUP=false` in **.env** and that containers were restarted.
2. Open **`http://localhost:3000/auth/sign-up`**.
3. Enter a valid e‑mail (e.g. `admin@hurriyetpartisi.org`) + a strong password (≥10 chars, 1 upper, 1 digit).
4. Click **Sign up**.  The **first** account automatically becomes **Owner** of a new organisation *Hurriyet Partisi* and default project *ai‑gateway*.
5. Copy the **Public** / **Secret** project keys from **Settings → API Keys** and add them to your FastAPI `.env`:

   ```env
   LANGFUSE_PUBLIC_KEY=<copied>
   LANGFUSE_SECRET_KEY=<copied>
   ```

6. (Optional) For password‑reset e‑mails set `SMTP_HOST|PORT|USER|PASS` then restart the stack.

### 8.2 One‑shot bootstrap via env‑vars (🤖 headless/CI)

Add these variables to *both* Langfuse services **before first boot**:

```env
LANGFUSE_INIT_ORG_ID=hurriyet
LANGFUSE_INIT_PROJECT_ID=ai-gateway
LANGFUSE_INIT_PROJECT_PUBLIC_KEY=lf_pk_local
LANGFUSE_INIT_PROJECT_SECRET_KEY=lf_sk_local
LANGFUSE_INIT_USER_EMAIL=admin@hurriyetpartisi.org
LANGFUSE_INIT_USER_PASSWORD=StrongPass123!
```

On an empty DB Langfuse logs **“✅ Init complete”** and seeds the org, project & owner. Remove the vars afterwards or set `LANGFUSE_INIT_SKIP=true` to prevent repeats.

### 8.3 Invite additional members (👥)

* **Dashboard**: **Settings → Members → Invite**, enter e‑mail, choose role *(viewer / analyst / owner)*.
* **Admin API**:

  ```bash
  curl -X POST http://localhost:3000/api/admin/invite \
       -H "Authorization: Bearer <secret>" \
       -H "Content-Type: application/json" \
       -d '{"email":"user@example.com","role":"analyst"}'
  ```

### 8.4 Lock down public sign‑up (🔒)

After the owner exists:

```env
AUTH_DISABLE_SIGNUP=true
```

Restart both Langfuse containers; `/auth/sign-up` now shows “Sign‑up disabled”.

### 8.5 Password & 2FA hygiene (🛡️)

* Rotate the owner password every quarter.
* 2‑factor auth is planned (see GitHub issue #1438). Until then store recovery codes in a password manager.

---

## 9 · Ops & maintenance tips · Ops & maintenance tips

* **Backups** – run `clickhouse-backup create && clickhouse-backup upload` nightly to S3.
* **Retention** – set `LANGFUSE_RETENTION_DAYS=90` if GDPR requires longer trace storage.
* **Scaling** – when events >500 eps, flip `CLICKHOUSE_CLUSTER_ENABLED=true`, add replicas, and point the URL to the cluster DNS.

---

## 10 · Changelog

| Date       | Notes                                                |
| ---------- | ---------------------------------------------------- |
| 2025‑06‑27 | Initial doc with debug overhaul and step re‑ordering |
