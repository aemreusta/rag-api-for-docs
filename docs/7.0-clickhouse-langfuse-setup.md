# ClickHouseÂ +Â LangfuseÂ v3Â Stack â€”Â OperatorÂ Runbook

> **Scope**Â Â Selfâ€‘hosted Langfuse v3 with ClickHouse analytics for the **aiâ€‘gateway** chatbot behind *hurriyetpartisi.org*.
> **Outcome**Â Â Oneâ€‘command deploy, deterministic migrations, robust debug playbook, CI guardrails.

---

## 0Â Â· Quick checklist

| âœ”ï¸ | Step                   | Command / File                                                        |
| -- | ---------------------- | --------------------------------------------------------------------- |
|    | 1. Create secrets      | `cp .env.example .env && openssl rand -hex 32` (three times)          |
|    | 2. Reset CK on upgrade | `make clickhouse-reset`                                               |
|    | 3. Boot services       | `docker compose pull && docker compose up -d`                         |
|    | 4. Health probe        | `curl -f http://localhost:3000/api/public/health` â‡’ `{"status":"ok"}` |
|    | 5. UI signâ€‘in          | open `/auth/sign-up`, create first owner                              |

Check all ticks âœ stack is ready.

---

## 1Â Â· Prerequisites

* **DockerÂ 24+** with Compose plugin.
* **Ports** free: 3000 (Langfuse UI), 8123/9000 (ClickHouse), 5432 (Postgres), 6379 (Redis).
* **64â€‘hex secret** for `CLICKHOUSE_PASSWORD`; **32â€‘hex** for `NEXTAUTH_SECRET`.

---

## 2Â Â· Environment file (`.env`)

```dotenv
# â”€â”€ ClickHouse â”€â”€
CLICKHOUSE_URL=http://clickhouse:8123
CLICKHOUSE_MIGRATION_URL=clickhouse://clickhouse:9000
CLICKHOUSE_USER=langfuse
CLICKHOUSE_PASSWORD=<64â€‘hex>
CLICKHOUSE_DB=langfuse
CLICKHOUSE_CLUSTER_ENABLED=false

# â”€â”€ Langfuse â”€â”€
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=<32â€‘hex>
AUTH_DISABLE_SIGNUP=false   # toggle after first owner exists
```

> **Tip**Â Â Add `SMTP_*` keys now if you need passwordâ€‘reset eâ€‘mails.

---

## 3Â Â· Compose services (essentials)

```yaml
clickhouse:
  image: clickhouse/clickhouse-server:24.3
  environment:
    CLICKHOUSE_USER: langfuse
    CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
    CLICKHOUSE_DB: langfuse
    CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
  healthcheck:
    test: ["CMD-SHELL", "wget -qO- http://localhost:8123/ping || exit 1"]
    interval: 5s
    retries: 20

langfuse:
  image: ghcr.io/langfuse/langfuse:latest
  env_file: .env
  depends_on:
    clickhouse:
      condition: service_healthy

langfuse-worker:
  image: ghcr.io/langfuse/langfuse:latest
  env_file: .env
  environment:
    LANGFUSE_AUTO_CLICKHOUSE_MIGRATION_DISABLED: "true"
  depends_on:
    langfuse:
      condition: service_started
```

*`CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1`* stops the blankâ€‘password bug. Worker waits, so only the web runs migrations.

---

## 4Â Â· Firstâ€‘time (or upgrade) procedure

1. **Stop old stack** Â `docker compose down`
2. **Optional wipe** Â Â `make clickhouse-reset` (drops `clickhouse_data` volume)
3. **Boot**Â Â Â Â Â Â Â Â Â Â Â Â `docker compose pull && docker compose up -d`
4. **Tail CK logs**Â Â Â Â `docker compose logs -f clickhouse | grep "Ready for connections"`
5. **Health probe**Â Â Â Â `curl -f http://localhost:3000/api/public/health`
6. **Create owner**Â Â Â Â open `/auth/sign-up` â†’ enter `admin@hurriyetpartisi.org` + password.

---

## 5Â Â· Smoke tests (copyâ€‘paste)

```bash
# 1. ClickHouse auth roundâ€‘trip
CKPW=$(grep CLICKHOUSE_PASSWORD .env | cut -d= -f2)
docker compose exec clickhouse clickhouse-client -u langfuse --password $CKPW -q "SELECT 1"   # -> 1

# 2. Grants
docker compose exec clickhouse clickhouse-client -u langfuse --password $CKPW -q "SHOW GRANTS" | grep langfuse

# 3. Langfuse health
curl -f http://localhost:3000/api/public/health
```

---

## 6Â Â· Deepâ€‘debug playbook

| What to inspect           | Command                                                                                                     |                   |
| ------------------------- | ----------------------------------------------------------------------------------------------------------- | ----------------- |
| Env vars inside container | \`docker compose exec langfuse printenv                                                                     | grep CLICKHOUSE\` |
| Langfuse migration list   | `docker compose exec langfuse sqlite3 /data/sqlite.db '.tables'` *(selfâ€‘host DB for ORM state)*             |                   |
| ClickHouse system tables  | `docker compose exec clickhouse clickhouse-client -q 'SELECT * FROM system.users WHERE name="langfuse"'`    |                   |
| Pending mutations         | `docker compose exec clickhouse clickhouse-client -q 'SELECT database,table,is_done FROM system.mutations'` |                   |
| Firewall / port           | `docker exec -it $(docker ps -q -f name=langfuse) bash -c 'nc -zv clickhouse 9000'`                         |                   |

### Common errors & fixes

| Log snippet                                       | Root cause         | Fix                                                                                         |
| ------------------------------------------------- | ------------------ | ------------------------------------------------------------------------------------------- |
| `Code: 516, DB::Exception: Authentication failed` | password mismatch  | reâ€‘export correct `CLICKHOUSE_PASSWORD` in both compose & .env, then `docker compose up -d` |
| `driver: bad connection`                          | URL uses localhost | replace with service name `clickhouse`                                                      |
| `schema_migrations already locked`                | web & worker raced | ensure worker flag `LANGFUSE_AUTO_CLICKHOUSE_MIGRATION_DISABLED=true`                       |
| `Signâ€‘up disabled` banner                         | auth locked        | set `AUTH_DISABLE_SIGNUP=false` until owner is created then flip back                       |

---

## 7Â Â· CI / CD guardrail

```yaml
jobs:
  e2e-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Launch stack
        run: docker compose up -d --wait
      - name: Probe health
        run: curl -f http://localhost:3000/api/public/health
```

Fails fast when env vars go missing.

---

## 8Â Â· InitialÂ User,Â OrganisationÂ &Â ProjectÂ Bootstrap

> **Goal**Â Â Create the first owner account, organisation and project so Langfuse becomes usable and API keys exist.

### 8.1Â Fast interactive signâ€‘upÂ (ğŸŒÂ UI)

1. Confirm `AUTH_DISABLE_SIGNUP=false` in **.env** and that containers were restarted.
2. Open **`http://localhost:3000/auth/sign-up`**.
3. Enter a valid eâ€‘mail (e.g. `admin@hurriyetpartisi.org`) + a strong password (â‰¥10 chars, 1â€¯upper, 1â€¯digit).
4. Click **SignÂ up**.  The **first** account automatically becomes **Owner** of a new organisation *HurriyetÂ Partisi* and default project *aiâ€‘gateway*.
5. Copy the **Public** / **Secret** project keys from **Settings â†’ APIÂ Keys** and add them to your FastAPI `.env`:

   ```env
   LANGFUSE_PUBLIC_KEY=<copied>
   LANGFUSE_SECRET_KEY=<copied>
   ```

6. (Optional) For passwordâ€‘reset eâ€‘mails set `SMTP_HOST|PORT|USER|PASS` then restart the stack.

### 8.2Â Oneâ€‘shot bootstrap via envâ€‘varsÂ (ğŸ¤–Â headless/CI)

Add these variables to *both* Langfuse services **before first boot**:

```env
LANGFUSE_INIT_ORG_ID=hurriyet
LANGFUSE_INIT_PROJECT_ID=ai-gateway
LANGFUSE_INIT_PROJECT_PUBLIC_KEY=lf_pk_local
LANGFUSE_INIT_PROJECT_SECRET_KEY=lf_sk_local
LANGFUSE_INIT_USER_EMAIL=admin@hurriyetpartisi.org
LANGFUSE_INIT_USER_PASSWORD=StrongPass123!
```

On an empty DB Langfuse logs **â€œâœ… Init completeâ€** and seeds the org, project & owner. Remove the vars afterwards or set `LANGFUSE_INIT_SKIP=true` to prevent repeats.

### 8.3Â Invite additional membersÂ (ğŸ‘¥)

* **Dashboard**: **Settings â†’ Members â†’ Invite**, enter eâ€‘mail, choose role *(viewer / analyst / owner)*.
* **Admin API**:

  ```bash
  curl -X POST http://localhost:3000/api/admin/invite \
       -H "Authorization: Bearer <secret>" \
       -H "Content-Type: application/json" \
       -d '{"email":"user@example.com","role":"analyst"}'
  ```

### 8.4Â Lock down public signâ€‘upÂ (ğŸ”’)

After the owner exists:

```env
AUTH_DISABLE_SIGNUP=true
```

Restart both Langfuse containers; `/auth/sign-up` now shows â€œSignâ€‘up disabledâ€.

### 8.5Â Password & 2FA hygieneÂ (ğŸ›¡ï¸)

* Rotate the owner password every quarter.
* 2â€‘factor auth is planned (see GitHub issueÂ #1438). Until then store recovery codes in a password manager.

---

## 9Â Â· Ops & maintenance tipsÂ Â· Ops & maintenance tips

* **Backups** â€“ run `clickhouse-backup create && clickhouse-backup upload` nightly to S3.
* **Retention** â€“ set `LANGFUSE_RETENTION_DAYS=90` if GDPR requires longer trace storage.
* **Scaling** â€“ when events >500 eps, flip `CLICKHOUSE_CLUSTER_ENABLED=true`, add replicas, and point the URL to the cluster DNS.

---

## 10Â Â· Changelog

| Date       | Notes                                                |
| ---------- | ---------------------------------------------------- |
| 2025â€‘06â€‘27 | Initial doc with debug overhaul and step reâ€‘ordering |
