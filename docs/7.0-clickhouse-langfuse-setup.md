# ClickHouse + Langfuse v3 Stack — Operator Runbook

> **Scope**  Self‑hosted Langfuse v3 with ClickHouse analytics + MinIO S3 storage for the **ai‑gateway** chatbot behind *hurriyetpartisi.org*.
> **Outcome**  One‑command deploy, deterministic migrations, robust debug playbook, CI guardrails.
> **Critical**  Langfuse v3 REQUIRES S3 storage configuration or it will crash with ZodError.

---

## 0 · Quick checklist

| ✔️ | Step                   | Command / File                                                        |
| -- | ---------------------- | --------------------------------------------------------------------- |
|    | 1. Create secrets      | `openssl rand -hex 32` (repeat 4 times for required secrets)          |
|    | 2. Configure .env      | Copy `.env.example` to `.env` and fill in generated secrets           |
|    | 3. Reset on upgrade    | `make clickhouse-reset` (if upgrading)                                |
|    | 4. Boot services       | `docker compose pull && docker compose up -d`                         |
|    | 5. Health probe        | `curl -f http://localhost:3000/api/public/health` ⇒ `{"status":"ok"}` |
|    | 6. UI sign‑in          | open `/auth/sign-up`, create first owner                              |

Check all ticks ➜ stack is ready.

---

## 1 · Prerequisites

* **Docker 24+** with Compose plugin.
* **Ports** free: 3000 (Langfuse UI), 8123/9000 (ClickHouse), 5432 (Postgres), 6379 (Redis), 9090/9091 (MinIO).
* **Environment file** with all required secrets (see section 2).

---

## 2 · Environment file (`.env`) - CRITICAL SETUP

**⚠️ BREAKING CHANGE**: Langfuse v3 requires S3 storage configuration. Without it, you'll get:

```
ZodError: LANGFUSE_S3_EVENT_UPLOAD_BUCKET expected string, received undefined
```

### 2.1 Generate Required Secrets

```bash
# Generate all required secrets
echo "NEXTAUTH_SECRET=$(openssl rand -hex 32)" >> .env
echo "SALT=$(openssl rand -hex 32)" >> .env  
echo "ENCRYPTION_KEY=$(openssl rand -hex 32)" >> .env
echo "CLICKHOUSE_PASSWORD=$(openssl rand -hex 32)" >> .env
```

### 2.2 Complete .env Configuration

```dotenv
# ── Core Langfuse Secrets ──
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=<64-hex-from-above>
SALT=<64-hex-from-above>
ENCRYPTION_KEY=<64-hex-from-above>

# ── ClickHouse ──
CLICKHOUSE_URL=http://clickhouse:8123
CLICKHOUSE_MIGRATION_URL=clickhouse://clickhouse:9000
CLICKHOUSE_USER=langfuse
CLICKHOUSE_PASSWORD=<64-hex-from-above>
CLICKHOUSE_DB=langfuse
CLICKHOUSE_CLUSTER_ENABLED=false

# ── MinIO/S3 Storage (REQUIRED) ──
MINIO_ROOT_USER=minio
MINIO_ROOT_PASSWORD=miniosecret

# S3 Event Upload (MANDATORY - Langfuse crashes without these)
LANGFUSE_S3_EVENT_UPLOAD_BUCKET=langfuse
LANGFUSE_S3_EVENT_UPLOAD_REGION=auto
LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID=minio
LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=miniosecret
LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=http://minio:9000
LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE=true
LANGFUSE_S3_EVENT_UPLOAD_PREFIX=events/

# ── Redis ──
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_AUTH=myredissecret

# ── Bootstrap (Auto-creates first user) ──
LANGFUSE_INIT_ORG_ID=my-org
LANGFUSE_INIT_PROJECT_ID=my-project
LANGFUSE_INIT_PROJECT_PUBLIC_KEY=lf_pk_local
LANGFUSE_INIT_PROJECT_SECRET_KEY=lf_sk_local
LANGFUSE_INIT_USER_EMAIL=ai@gencturkler.co
LANGFUSE_INIT_USER_PASSWORD=gencturk123
```

> **Reference**: Based on [official Langfuse docker-compose.yml](https://raw.githubusercontent.com/langfuse/langfuse/main/docker-compose.yml)

---

## 3 · Compose services (updated for v3)

Key changes from previous versions:

```yaml
# MinIO S3-compatible storage (NEW - REQUIRED)
minio:
  image: minio/minio
  command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
  environment:
    MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
    MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniosecret}
  ports:
    - "9090:9000"       # S3 API
    - "127.0.0.1:9091:9001"   # MinIO Console
  healthcheck:
    test: ["CMD", "mc", "ready", "local"]

# Langfuse with S3 configuration (UPDATED)
langfuse:
  image: ghcr.io/langfuse/langfuse:latest
  environment:
    # All the S3 variables are now REQUIRED
    - LANGFUSE_S3_EVENT_UPLOAD_BUCKET=langfuse
    - LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=http://minio:9000
    # ... (see docker-compose.yml for complete config)
  depends_on:
    minio: {condition: service_healthy}  # NEW dependency
```

*MinIO auto-creates the 'langfuse' bucket on startup. Both langfuse-web and langfuse-worker need identical S3 vars.*

---

## 4 · First‑time (or upgrade) procedure

### 4.1 Complete Reset (if upgrading from older versions)

```bash
# Stop everything
docker compose down

# Remove old volumes (CAUTION: destroys data)
docker volume rm chatbot-api-service_clickhouse_data
docker volume rm chatbot-api-service_minio_data

# Ensure .env has all required S3 variables
cp .env.example .env
# Edit .env with your secrets (see section 2)
```

### 4.2 Start Services

```bash
# Pull latest images
docker compose pull

# Start all services
docker compose up -d

# Watch startup logs
docker compose logs -f langfuse langfuse-worker minio clickhouse
```

### 4.3 Verify Health

```bash
# Check all services are ready
curl -f http://localhost:3000/api/public/health        # Langfuse
curl -f http://localhost:9090/minio/health/ready       # MinIO
curl -f http://localhost:8123/ping                     # ClickHouse
```

---

## 5 · Smoke tests (copy‑paste)

```bash
# 1. ClickHouse auth round‑trip
CKPW=$(grep CLICKHOUSE_PASSWORD .env | cut -d= -f2)
docker compose exec clickhouse clickhouse-client -u langfuse --password $CKPW -q "SELECT 1"   # -> 1

# 2. MinIO S3 connectivity
docker compose exec langfuse curl -f http://minio:9000/minio/health/ready

# 3. S3 bucket exists
docker compose exec minio mc ls local/langfuse/

# 4. Langfuse health
curl -f http://localhost:3000/api/public/health
```

---

## 6 · Deep‑debug playbook

### 6.1 Common S3-related Errors

| Error Symptom | Root Cause | Fix |
|---------------|------------|-----|
| `ZodError: LANGFUSE_S3_EVENT_UPLOAD_BUCKET expected string, received undefined` | Missing S3 env vars | Add all `LANGFUSE_S3_EVENT_UPLOAD_*` variables to .env |
| `TypeError: Cannot set property message of ZodError` | Same as above but Next.js crash | Same fix + restart containers |
| `Error: getaddrinfo ENOTFOUND minio` | MinIO service not healthy | Wait for MinIO healthcheck, check `docker compose logs minio` |
| `Code: 1002, e.displayText() = DB::Exception: File doesn't exist` | ClickHouse can't reach MinIO | Ensure both services on same network |

### 6.2 Debug Commands

| What to inspect           | Command                                                                                                     |
| ------------------------- | ----------------------------------------------------------------------------------------------------------- |
| S3 env vars inside container | `docker compose exec langfuse printenv \| grep LANGFUSE_S3`                                              |
| MinIO bucket list         | `docker compose exec minio mc ls local/`                                                                   |
| Langfuse startup logs     | `docker compose logs langfuse \| grep -E "(Ready\|Error\|S3)"`                                            |
| Worker S3 connectivity   | `docker compose exec langfuse-worker curl -f http://minio:9000/minio/health/ready`                        |
| ClickHouse system tables  | `docker compose exec clickhouse clickhouse-client -q 'SELECT * FROM system.users WHERE name="langfuse"'`    |

### 6.3 S3 Configuration Validation

```bash
# Verify all required S3 vars are set
docker compose exec langfuse bash -c '
echo "Bucket: $LANGFUSE_S3_EVENT_UPLOAD_BUCKET"
echo "Endpoint: $LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT"  
echo "Access Key: $LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID"
echo "Secret: ${LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY:0:8}..."
'
```

---

## 7 · CI / CD guardrail

Updated to include MinIO health check:

```yaml
jobs:
  e2e-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate secrets
        run: |
          echo "NEXTAUTH_SECRET=$(openssl rand -hex 32)" >> .env
          echo "SALT=$(openssl rand -hex 32)" >> .env
          echo "ENCRYPTION_KEY=$(openssl rand -hex 32)" >> .env
          echo "CLICKHOUSE_PASSWORD=$(openssl rand -hex 32)" >> .env
      - name: Launch stack
        run: docker compose up -d --wait
      - name: Test health endpoints
        run: |
          curl -f http://localhost:3000/api/public/health
          curl -f http://localhost:9090/minio/health/ready
          curl -f http://localhost:8123/ping
```

---

## 8 · Initial User, Organisation & Project Bootstrap

> **Goal**  Create the first owner account, organisation and project so Langfuse becomes usable and API keys exist.

### 8.1 Automatic Bootstrap (Recommended)

Set these in your `.env` **before first boot**:

```env
LANGFUSE_INIT_ORG_ID=my-org
LANGFUSE_INIT_PROJECT_ID=my-project
LANGFUSE_INIT_PROJECT_PUBLIC_KEY=lf_pk_local
LANGFUSE_INIT_PROJECT_SECRET_KEY=lf_sk_local
LANGFUSE_INIT_USER_EMAIL=ai@gencturkler.co
LANGFUSE_INIT_USER_PASSWORD=gencturk123
```

On empty database, Langfuse logs **"✅ Init complete"** and auto-creates org/project/user.

### 8.2 Manual UI Setup (Alternative)

1. Ensure `AUTH_DISABLE_SIGNUP=false` in .env
2. Open **`http://localhost:3000/auth/sign-up`**
3. Create admin account: `ai@gencturkler.co` + strong password
4. Copy API keys from **Settings → API Keys**

### 8.3 Lock Down After Setup

```env
AUTH_DISABLE_SIGNUP=true  # Disable public signup
```

---

## 9 · Ops & maintenance tips

* **Backups** – MinIO data in `minio_data` volume; ClickHouse in `clickhouse_data`
* **Retention** – set `LANGFUSE_RETENTION_DAYS=90` for GDPR compliance
* **Storage monitoring** – MinIO console at `http://localhost:9091` (admin/password from env)
* **S3 migration** – Point `LANGFUSE_S3_*_ENDPOINT` to AWS S3 for production

---

## 10 · Production considerations

### 10.1 Replace MinIO with AWS S3

For production, replace MinIO with real S3:

```env
# Remove MinIO service from docker-compose.yml
# Update these variables:
LANGFUSE_S3_EVENT_UPLOAD_BUCKET=your-s3-bucket
LANGFUSE_S3_EVENT_UPLOAD_REGION=us-east-1
LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID=AKIA...
LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=your-secret
LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=https://s3.amazonaws.com
LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE=false
```

### 10.2 Security hardening

* Set strong passwords for all `*_PASSWORD` variables
* Use IAM roles instead of access keys in AWS
* Enable TLS for all external connections
* Restrict network access to internal services only

---

## 11 · Changelog

| Date       | Notes                                                |
| ---------- | ---------------------------------------------------- |
| 2025‑01‑27 | Added MinIO requirement, S3 configuration, updated troubleshooting for v3 |
| 2025‑06‑27 | Initial doc with debug overhaul and step re‑ordering |
