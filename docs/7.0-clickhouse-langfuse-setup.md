# ClickHouse & Langfuse Setup Guide

This guide addresses common ClickHouse authentication and migration race issues when using Langfuse v3.

## Problem Summary

Migrations fail because ClickHouse starts with an empty password when `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1` is missing. Langfuse tries the hashed secret in `.env` and gets "authentication failed". Additionally, race conditions occur when both langfuse and langfuse-worker attempt migrations simultaneously.

## Solution Overview

Our docker-compose.yml implements the following fixes:

1. **Proper ClickHouse Environment Variables**: The four mandatory env-vars trigger the entry-point to create the `langfuse` user and database with the supplied password.

2. **Migration Race Prevention**: The worker service disables auto-migration and depends on the main langfuse service to complete migrations first.

3. **Health Checks**: ClickHouse health check ensures the service is ready before Langfuse attempts connection.

## Setup Instructions

### 1. Environment Configuration

Copy `.env.example` to `.env` and update the ClickHouse credentials:

```env
# ClickHouse
CLICKHOUSE_URL=http://clickhouse:8123
CLICKHOUSE_MIGRATION_URL=clickhouse://clickhouse:9000
CLICKHOUSE_USER=langfuse
CLICKHOUSE_PASSWORD=<your-secure-hex-secret>
CLICKHOUSE_DB=langfuse
CLICKHOUSE_CLUSTER_ENABLED=false
```

Generate a secure password:

```bash
openssl rand -hex 32
```

### 2. Reset ClickHouse Volume (if upgrading)

If you're upgrading from a previous setup:

```bash
docker compose down
docker volume rm chatbot-api-service_clickhouse_data
```

### 3. Start Services

```bash
docker compose pull && docker compose up -d
```

Watch the ClickHouse logs until you see "Creating user: langfuse" followed by "Ready for connections":

```bash
docker compose logs -f clickhouse
```

## Verification Tests

Run these smoke tests to verify the setup:

### 1. ClickHouse Authentication

```bash
docker compose exec clickhouse clickhouse-client -u langfuse --password $CLICKHOUSE_PASSWORD -q 'SELECT 1'
```

Expected: `1`

### 2. User Grants

```bash
docker compose exec clickhouse clickhouse-client -u langfuse --password $CLICKHOUSE_PASSWORD -q "SHOW GRANTS"
```

Expected: Must include `INSERT`, `SELECT`, `CREATE`, `ALTER` on `langfuse.*`

### 3. Langfuse Health

```bash
curl -f http://localhost:3000/api/public/health
```

Expected: `{"status":"ok"}`

## Troubleshooting

### Common Errors and Solutions

| Error | Cause | Solution |
|-------|-------|----------|
| `driver: bad connection` | Wrong host/port | Use `clickhouse` not `localhost` in URLs |
| `Code: 516, DB::Exception: Authentication failed` | Password mismatch | Check CLICKHOUSE_PASSWORD in .env |
| `non-zero exit before migrations` | Worker still running migrations | Ensure LANGFUSE_AUTO_CLICKHOUSE_MIGRATION_DISABLED=true |

### Debug Commands

View service logs:

```bash
docker compose logs -f langfuse
docker compose logs -f langfuse-worker
docker compose logs -f clickhouse
```

Check service health:

```bash
docker compose ps
```

## Architecture Notes

### Service Dependencies

```
ClickHouse (healthy) → Langfuse (migrations) → Langfuse-Worker (waits)
```

1. **ClickHouse**: Starts with health check, creates user/database on first run
2. **Langfuse**: Waits for ClickHouse health, runs migrations
3. **Langfuse-Worker**: Waits for Langfuse to start, migrations disabled

### Key Configuration Points

- `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1`: Enables proper user/password setup
- `LANGFUSE_AUTO_CLICKHOUSE_MIGRATION_DISABLED=true`: Prevents worker migration conflicts
- Service names in URLs: Ensures proper Docker network communication
- Health checks: Prevents premature connections

## CI/CD Integration

Add this smoke test to your CI pipeline:

```yaml
- name: Langfuse smoke test
  run: |
    docker compose up -d --wait
    curl -f http://localhost:3000/api/public/health
```

This catches "forgot the env-var" regressions on pull requests.
